<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonsai Do - Gestionnaire Pro</title>
    
    <link rel="icon" type="image/jpeg" href="1764885908678~2.jpg">
    <link rel="apple-touch-icon" href="1764885908678~2.jpg">

    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- DESIGN MODERNIS√â --- */
        :root { --primary: #4A90E2; --primary-dark: #3A70B9; --bg: #F0F2F5; --card-bg: #ffffff; --text: #212529; --secondary-text: #6C757D; --danger: #DC3545; --success: #28A745; --radius: 12px; --shadow: 0 4px 12px rgba(0,0,0,0.08); }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); -webkit-tap-highlight-color: transparent; font-size: 16px; }
        
        /* HEADER: Titre Horizontal et Alignement Gauche */
        .app-header { 
            background: var(--primary); 
            color: var(--card-bg); 
            padding: 16px 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); 
            font-weight: 600; 
            transition: height 0.3s;
        }

        /* Alignement Gauche du Titre */
        .header-top { 
            display: flex; 
            justify-content: space-between; /* Titre √† gauche, compteur √† droite */
            width: 100%; 
            align-items: center; 
            position: relative;
        }
        
        /* Titre (2x plus grand, horizontal, align√© √† gauche) */
        .header-title { 
            display: flex; 
            align-items: center; 
            font-size: 2rem; 
        }
        
        /* Compteur d'arbres */
        .bonsai-count { 
            font-size: 0.75rem; 
            background: rgba(255,255,255,0.25); 
            padding: 2px 8px; 
            border-radius: 10px; 
            /* Reste √† droite gr√¢ce √† justify-content: space-between */
        }

        /* Barre de tri */
        .sort-bar { width: 100%; margin-top: 10px; display: flex; gap: 10px; }
        .sort-select { flex: 1; padding: 8px; border-radius: 6px; border: none; font-size: 0.9rem; background: rgba(255,255,255,0.2); color: white; font-weight: 600; }
        .sort-select option { color: #333; background: white; }
        
        /* NAVIGATION FIXE EN BAS (ic√¥nes 2x plus grandes) */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--card-bg); 
            height: 80px; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            border-top: 1px solid #E9ECEF; 
            z-index: 900; 
        }
        
        .nav-btn { 
            color: #ADB5BD; 
            background: none; 
            border: none; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 5px; 
        }
        
        .nav-btn i {
            font-size: 2.8rem; /* TAILLE DOUBL√âE */
            line-height: 1;
        }
        
        .nav-btn span { font-size: 0.7rem; margin-top: 4px; font-weight: 600; }
        .nav-btn.active { color: var(--primary); }
        
        /* CONTAINERS & LISTE */
        .main-container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid #E9ECEF; }
        .card h3 { border-bottom: 1px solid #F1F3F5; padding-bottom: 10px; margin: 0 0 15px 0; font-size: 1rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; }
        .bonsai-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #F1F3F5; cursor: pointer; transition: background 0.2s; }
        .bonsai-item:hover { background: #F8F9FA; }
        
        /* MODIFICATION PRECEDENTE : Taille 75px + Bords arrondis */
        .thumb-icon { width: 75px; height: 75px; border-radius: 12px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: var(--card-bg); border: 2px solid; flex-shrink: 0; overflow: hidden; background-size: cover; background-position: center; }
        
        /* FORM & INPUTS */
        .leaf-preview { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 180px; margin-bottom: 20px; border-radius: var(--radius); background: #E9ECEF; border: 1px dashed #ADB5BD; position: relative; overflow: hidden; }
        .leaf-preview img { width: 100%; height: 180px; object-fit: cover; position: absolute; top: 0; left: 0; }
        .placeholder-content { display: flex; flex-direction: column; align-items: center; z-index: 2; }
        .icon-container { width: 70px; height: 70px; border-radius: 50%; border: 4px solid; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; background: var(--card-bg); font-size: 2.5rem; }
        .form-group { margin-bottom: 15px; }
        label { display: block; color: var(--secondary-text); font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #CED4DA; border-radius: 8px; font-size: 16px; background: #fff; }
        
        /* SPECS */
        .specs-row { display: flex; justify-content: space-between; margin-top: 15px; text-align: center; }
        .spec-box { display: flex; flex-direction: column; align-items: center; width: 19%; }
        .icon-square { width: 38px; height: 38px; border-radius: 10px; border: 2px solid; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; background: white; font-size: 1rem; }
        .spec-text { font-size: 0.75rem; font-weight: 700; white-space: nowrap; overflow: hidden; max-width: 100%; }
        .c-blue { color: #3498db; border-color: #3498db; } .c-orange { color: #e67e22; border-color: #e67e22; } .c-green { color: #2ecc71; border-color: #2ecc71; }
        
        /* BOUTONS & SCREENS */
        .btn-action { display: block; width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bg-blue { background: var(--primary); } .bg-green { background: var(--success); } .bg-red { background: var(--danger); }
        .add-bonsai-btn-float { width: 100%; padding: 15px; margin-bottom: 20px; text-align: center; font-size: 1.1rem; font-weight: 700; background: var(--success); color: white; border: none; border-radius: var(--radius); cursor: pointer; }
        
        .screen { display: none; padding-bottom: 20px; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
        
        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: var(--success); color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 80px; font-size: 16px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        /* ICON STYLES */
        .style-√©rable-1 { color: #1E8449; border-color: #27AE60; } .style-pine-1 { color: #154360; border-color: #1A5276; }
    </style>
</head>
<body>

    <div id="screen-list" class="screen active">
        <div class="app-header">
            <div class="header-top">
                
                <span class="header-title">Bonsai Do</span>

                <span id="bonsai-count" class="bonsai-count">0</span>
            </div>
            <div class="sort-bar">
                <select class="sort-select" id="sort-filter" onchange="renderList()">
                    <option value="name_asc">üî§ Nom (A-Z)</option>
                    <option value="date_desc">üìÖ Ajout R√©cent</option>
                    <option value="species_asc">üåø Esp√®ce</option>
                    <option value="last_work">üõ†Ô∏è Dernier Travail</option>
                </select>
            </div>
        </div>
        <div class="main-container">
            <button class="add-bonsai-btn-float" onclick="openEditor(null)">
                <i class="fa-solid fa-plus"></i> Ajouter un arbre
            </button>
            <div id="list-container">Chargement de la base de donn√©es...</div>
        </div>
    </div>

    <div id="screen-calendar" class="screen">
        <div class="app-header">
            <div class="header-top" style="justify-content: center;">
                <span class="header-title"><i class="fa-solid fa-calendar-check"></i> Calendrier</span>
            </div>
        </div>
        <div class="main-container">
            <div class="card">
                <h3><i class="fa-solid fa-list-ul"></i> Travaux √† Venir</h3>
                <div id="calendar-list"></div>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="app-header">
            <div class="header-top" style="justify-content: center;">
                <span class="header-title"><i class="fa-solid fa-gear"></i> Param√®tres</span>
            </div>
        </div>
        <div class="main-container">
            <div class="card">
                <h3><i class="fa-solid fa-database"></i> Sauvegarde (JSON)</h3>
                <button class="btn-action bg-blue" onclick="downloadBackup()"><i class="fa-solid fa-download"></i> T√©l√©charger</button>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <label>Restaurer :</label>
                <input type="file" id="backup-file" accept=".json">
                <button class="btn-action bg-green" onclick="restoreBackup()"><i class="fa-solid fa-upload"></i> Restaurer</button>
            </div>
            <div class="card">
                 <h3><i class="fa-solid fa-mobile-screen"></i> Installation</h3>
                 <p style="font-size:0.9rem; color:var(--secondary-text)">Pour installer l'app, utilisez l'option "Ajouter √† l'√©cran d'accueil" de votre navigateur.</p>
            </div>
             <button class="btn-action bg-red" onclick="resetApp()">‚ö†Ô∏è Tout effacer</button>
        </div>
    </div>

    <div id="screen-edit" class="screen">
        <div class="app-header">
            <div class="header-top">
                <button class="header-btn" onclick="nav('list')"><i class="fa-solid fa-arrow-left"></i></button>
                <span id="editor-title">Nouveau</span>
                <div style="width:30px;"></div>
            </div>
        </div>
        <div class="main-container">
            <div class="card">
                <div class="leaf-preview" id="leaf-preview">
                    <img id="preview-image-tag" style="display:none;" />
                    <div class="placeholder-content" id="placeholder-content">
                        <div class="icon-container style-√©rable-1"><i class="fa-solid fa-cannabis"></i></div>
                        <div style="font-weight:600; color:var(--secondary-text)">Ajouter Photo</div>
                    </div>
                    <input type="file" id="photo-upload" accept="image/*" style="display:none;" onchange="handlePhotoUpload(this)">
                </div>
                <div style="text-align:center;">
                    <button class="btn-action bg-blue" style="width:auto; display:inline-block; margin:0;" onclick="document.getElementById('photo-upload').click()">Photo</button>
                    <button class="btn-action bg-red" style="width:auto; display:inline-block; margin:0;" onclick="removePhoto()"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="form-group" style="margin-top:15px;">
                    <label>Esp√®ce (Tapez pour rechercher)</label>
                    <input list="species-list" id="edit-species-input" onchange="updateSpecsFromInput()">
                    <datalist id="species-list"></datalist>
                </div>
                <div class="specs-row">
                    <div class="spec-box"><div class="icon-square c-blue"><i class="fa-solid fa-snowflake"></i></div><span class="spec-text" id="v-usda">-</span></div>
                    <div class="spec-box"><div class="icon-square c-orange"><i class="fa-solid fa-sun"></i></div><span class="spec-text" id="v-expo">-</span></div>
                    <div class="spec-box"><div class="icon-square c-green"><i class="fa-solid fa-leaf"></i></div><span class="spec-text" id="v-type">-</span></div>
                </div>
            </div>

            <div class="card">
                <h3>Identit√©</h3>
                <label>Surnom</label><input type="text" id="edit-name">
                <label>Date Achat</label><input type="date" id="edit-date">
            </div>

            <div class="card">
                <h3>Derniers Travaux</h3>
                <div style="display:flex; gap:10px;"><div style="flex:1"><label>Rempotage</label><input type="date" id="edit-last-pot"></div><div style="flex:1"><label>Taille</label><input type="date" id="edit-last-cut"></div></div>
                <div style="display:flex; gap:10px; margin-top:10px;"><div style="flex:1"><label>Effeuillage</label><input type="date" id="edit-last-defo"></div><div style="flex:1"><label>Engrais</label><input type="date" id="edit-last-fertil"></div></div>
                <div style="display:flex; gap:10px; margin-top:10px;"><div style="flex:1"><label>Ligature</label><input type="date" id="edit-last-wire"></div></div>
            </div>

            <div class="card">
                <h3>Observations</h3>
                <textarea id="edit-notes" rows="3" placeholder="Notes g√©n√©rales, taille, maladies..."></textarea>
            </div>

            <button class="btn-action bg-blue" onclick="saveBonsai()">üíæ Enregistrer</button>
            <button class="btn-action bg-red" id="btn-delete" style="margin-top: 10px;" onclick="deleteBonsai()">Supprimer</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" id="nav-list" onclick="nav('list')"><i class="fa-solid fa-seedling"></i><span>Arbres</span></button>
        <button class="nav-btn" id="nav-cal" onclick="nav('calendar')"><i class="fa-solid fa-calendar"></i><span>Calendrier</span></button>
        <button class="nav-btn" id="nav-set" onclick="nav('settings')"><i class="fa-solid fa-gear"></i><span>R√©glages</span></button>
    </div>
    <div id="toast"></div>

    <script>
        // --- 1. SERVICE WORKER REGISTRATION (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // S'assure que le chemin est correct (./sw.js)
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW enregistr√©:', reg))
                    .catch(err => console.log('SW erreur:', err));
            });
        }

        // --- 2. GESTION INDEXED DB (Stockage Pro) ---
        const DB_NAME = 'BonsaiDoDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'trees';

        const dbApi = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'uid' });
                        }
                    };
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            },
            getAll: async () => {
                const db = await dbApi.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            put: async (item) => {
                const db = await dbApi.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.put(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => {
                        if (e.target.error.name === "QuotaExceededError") {
                            showToast("Espace disque plein. Impossible de sauvegarder plus de photos.", true);
                        }
                        reject(e.target.error);
                    };
                });
            },
            delete: async (uid) => {
                const db = await dbApi.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.delete(uid);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            clear: async () => {
                const db = await dbApi.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    store.clear();
                    tx.oncomplete = () => resolve();
                });
            }
        };

        // --- 3. DATA & CONFIG (300 ESP√àCES INT√âGR√âES) ---
        const SPECIES_RAW = [
            "Abies concolor (Sapin)", "Abies koreana (Sapin de Cor√©e)", "Acacia dealbata (Mimosa)", "Acer buergerianum (√ârable de Burger)",
            "Acer campestre (√ârable champ√™tre)", "Acer ginnala (√ârable de l'Amour)", "Acer palmatum (√ârable japonais)", "Acer pseudoplatanus (√ârable sycomore)",
            "Aesculus hippocastanum (Marronnier)", "Albizia julibrissin (Arbre de soie)", "Alnus glutinosa (Aulne glutineux)", "Amelanchier lamarckii (Am√©lanchier)",
            "Araucaria araucana (D√©sespoir des singes)", "Arbutus unedo (Arbousier)", "Bambusa (Bambou)", "Bauhinia variegata (Arbre aux orchid√©es)",
            "Betula pendula (Bouleau pleureur)", "Betula pubescens (Bouleau pubescent)", "Buxus sempervirens (Buis)", "Callistemon citrinus (Rince-bouteilles)",
            "Carpinus betulus (Charme)", "Carya ovata (Noyer tendre)", "Castanea sativa (Ch√¢taignier)", "Catalpa bignonioides (Catalpa commun)",
            "Cedrus atlantica (C√®dre de l'Atlas)", "Cedrus libani (C√®dre du Liban)", "Celtis australis (Micocoulier)", "Cercis siliquastrum (Arbre de Jud√©e)",
            "Chamaecyparis lawsoniana (Faux cypr√®s)", "Chamaecyparis obtusa (Cypr√®s Hinoki)", "Chionanthus virginicus (Arbre √† neige)", "Citrus limon (Citronnier)",
            "Citrus sinensis (Oranger)", "Cornus florida (Cornouiller)", "Cornus kousa (Cornouiller de Kousa)", "Corylus avellana (Noisetier)",
            "Cotoneaster horizontalis (Coton√©aster)", "Crataegus monogyna (Aub√©pine)", "Cryptomeria japonica (C√®dre du Japon)", "Cupressus sempervirens (Cypr√®s)",
            "Diospyros kaki (Plaqueminier)", "Elaeagnus angustifolia (Olivier de Boh√™me)", "Eriobotrya japonica (N√©flier)", "Eucalyptus globulus (Eucalyptus)",
            "Fagus sylvatica (H√™tre commun)", "Ficus benghalensis (Figuier de l'Inde)", "Ficus carica (Figuier commun)", "Ficus retusa (Figuier Retusa)",
            "Fraxinus excelsior (Fr√™ne commun)", "Ginkgo biloba (Arbre aux quarante √©cus)", "Gleditsia triacanthos (F√©vier)", "Ilex aquifolium (Houx)",
            "Jacaranda mimosifolia (Jacaranda)", "Juglans regia (Noyer commun)", "Juniperus communis (Gen√©vrier commun)", "Juniperus procumbens (Gen√©vrier rampant)",
            "Koelreuteria paniculata (Arbre aux lanternes)", "Lagerstroemia indica (Lilas des Indes)", "Larix decidua (M√©l√®ze d'Europe)", "Liquidambar styraciflua (Copalme)",
            "Liriodendron tulipifera (Tulipier)", "Magnolia grandiflora (Magnolia)", "Malus sylvestris (Pommier sauvage)", "Morus alba (M√ªrier blanc)",
            "Nandina domestica (Bambou sacr√©)", "Nyssa sylvatica (Tupelo)", "Olea europaea (Olivier)", "Parrotia persica (Parrotie de Perse)",
            "Picea abies (√âpic√©a commun)", "Picea pungens (√âpic√©a bleu)", "Pinus mugo (Pin de montagne)", "Pinus nigra (Pin noir d'Autriche)",
            "Pinus parviflora (Pin blanc du Japon)", "Pinus sylvestris (Pin sylvestre)", "Pinus thunbergii (Pin noir du Japon)", "Platanus hispanica (Platane)",
            "Podocarpus macrophyllus (Podocarpe)", "Populus nigra (Peuplier noir)", "Prunus avium (Merisier)", "Prunus cerasifera (Prunier-cerise)",
            "Prunus serrulata (Cerisier du Japon)", "Punica granatum (Grenadier)", "Pyrus communis (Poirier commun)", "Quercus ilex (Ch√™ne vert)",
            "Quercus robur (Ch√™ne p√©doncul√©)", "Quercus suber (Ch√™ne-li√®ge)", "Rhododendron (Rhododendron)", "Robinia pseudoacacia (Robinier)",
            "Salix babylonica (Saule pleureur)", "Sequoia sempervirens (S√©quoia)", "Sophora japonica (Sophora)", "Sorbus aucuparia (Sorbier)",
            "Taxodium distichum (Cypr√®s chauve)", "Taxus baccata (If commun)", "Thuja occidentalis (Thuya)", "Tilia cordata (Tilleul)",
            "Tsuga canadensis (Pruche du Canada)", "Ulmus minor (Orme champ√™tre)", "Ulmus parvifolia (Orme de Chine)", "Wisteria sinensis (Glycine)",
            "Zelkova serrata (Orme du Japon)", "Acacia retinodes (Mimosa des quatre saisons)", "Cupressus arizonica (Cypr√®s bleu)", "Lagerstroemia fauriei (Lilas des Indes)",
            "Liquidambar orientalis (Copalme d'Orient)", "Magnolia soulangeana (Magnolia de Soulange)", "Picea orientalis (√âpic√©a d'Orient)", "Pinus pinea (Pin parasol)",
            "Populus alba (Peuplier blanc)", "Prunus laurocerasus (Laurier-cerise)", "Pyrus calleryana (Poirier de Callery)", "Quercus cerris (Ch√™ne chevelu)",
            "Quercus coccifera (Ch√™ne kerm√®s)", "Robinia hispida (Faux-acacia)", "Salix caprea (Saule marsault)", "Sequoia giganteum (S√©quoia g√©ant)",
            "Sorbus torminalis (Alisier torminal)", "Taxodium mucronatum (Cypr√®s de Montezuma)", "Tilia platyphyllos (Tilleul √† larges feuilles)", "Tsuga heterophylla (Pruche de l'Ouest)",
            "Ulmus glabra (Orme de montagne)", "Wisteria floribunda (Glycine du Japon)", "Abies nordmanniana (Sapin de Nordmann)", "Acacia melanoxylon (Acacia noir)",
            "Acer negundo (√ârable √† feuilles de fr√™ne)", "Celtis sinensis (Micocoulier de Chine)", "Chamaecyparis pisifera (Faux cypr√®s de Sawara)", "Crataegus laevigata (Aub√©pine)",
            "Fagus orientalis (H√™tre d'Orient)", "Ilex crenata (Houx cr√©nel√©)", "Juglans nigra (Noyer noir)", "Juniperus chinensis (Gen√©vrier de Chine)",
            "Koelreuteria bipinnata (Arbre aux lanternes)", "Larix kaempferi (M√©l√®ze du Japon)", "Magnolia stellata (Magnolia √©toil√©)", "Morus rubra (M√ªrier rouge)",
            "Olea capensis (Olivier du Cap)", "Picea omorika (√âpic√©a de Serbie)", "Pinus densiflora (Pin rouge du Japon)", "Platanus orientalis (Platane d'Orient)",
            "Populus tremula (Tremble)", "Prunus padus (Merisier √† grappes)", "Pyrus nivalis (Poirier des neiges)", "Quercus faginea (Ch√™ne du Portugal)",
            "Quercus macrocarpa (Ch√™ne √† gros fruits)", "Robinia viscosa (Robinier visqueux)", "Salix matsudana (Saule tortueux)", "Sequoia sempervirens 'Aptos Blue' (S√©quoia bleu)",
            "Sorbus domestica (Cormier)", "Taxus cuspidata (If du Japon)", "Tilia americana (Tilleul d'Am√©rique)", "Tsuga mertensiana (Pruche de montagne)",
            "Ulmus pumila (Orme de Sib√©rie)", "Wisteria brachybotrys (Glycine √† fleurs courtes)", "Abies fraseri (Sapin de Fraser)", "Acacia verticillata (Acacia verticill√©)",
            "Acer rubrum (√ârable rouge)", "Celtis occidentalis (Micocoulier occidental)", "Chamaecyparis thyoides (Cypr√®s blanc)", "Crataegus viridis (Aub√©pine verte)",
            "Fagus grandifolia (H√™tre d'Am√©rique)", "Ilex serrata (Houx dentel√©)", "Juglans cinerea (Noyer cendr√©)", "Juniperus horizontalis (Gen√©vrier rampant)",
            "Koelreuteria elegans (Arbre aux lanternes)", "Liquidambar formosana (Copalme de Chine)", "Magnolia tripetala (Magnolia parapluie)", "Morus celtidifolia (M√ªrier celtid√©)",
            "Olea lancea (Olivier lanc√©ol√©)", "Picea sitchensis (√âpic√©a de Sitka)", "Pinus flexilis (Pin flexible)", "Platanus racemosa (Platane de Californie)",
            "Populus trichocarpa (Peuplier baumier)", "Prunus serasus (Cerisier acide)", "Pyrus salicifolia (Poirier √† feuilles de saule)", "Quercus coccinea (Ch√™ne √©carlate)",
            "Quercus palustris (Ch√™ne des marais)", "Robinia neomexicana (Robinier du Nouveau-Mexique)", "Salix purpurea (Saule pourpre)", "Sequoia sempervirens 'Filoli' (S√©quoia Filoli)",
            "Sorbus intermedia (Sorbier de Su√®de)", "Taxus media (If hybride)", "Tilia heterophylla (Tilleul h√©t√©rophylle)", "Tsuga sieboldii (Pruche du Japon)",
            "Ulmus davidiana (Orme de David)", "Wisteria frutescens (Glycine am√©ricaine)", "Abies procera (Sapin noble)", "Acacia longifolia (Mimosa longifolia)",
            "Acer saccharum (√ârable √† sucre)", "Celtis reticulata (Micocoulier r√©ticul√©)", "Chamaecyparis nootkatensis (Cypr√®s de Nootka)", "Crataegus phaenopyrum (Aub√©pine d'Am√©rique)",
            "Fagus lucida (H√™tre brillant)", "Ilex verticillata (Houx verticill√©)", "Juglans hindsii (Noyer de Hinds)", "Juniperus squamata (Gen√©vrier √©cailleux)",
            "Koelreuteria paniculata 'Fastigiata' (Arbre aux lanternes)", "Liquidambar orientalis 'Rotundiloba' (Copalme d'Orient)", "Magnolia virginiana (Magnolia vierge)", "Morus microphylla (M√ªrier microphyle)",
            "Olea paniculata (Olivier paniculaire)", "Picea breweriana (√âpic√©a de Brewer)", "Pinus jeffreyi (Pin de Jeffrey)", "Platanus wrightii (Platane de Wright)",
            "Populus deltoides (Peuplier delto√Øde)", "Prunus subhirtella (Cerisier d'hiver)", "Pyrus betulifolia (Poirier √† feuilles de bouleau)", "Quercus dentata (Ch√™ne √† dents)",
            "Quercus rubra (Ch√™ne rouge)", "Robinia √ó ambigua (Robinier ambigu)", "Salix viminalis (Saule des vanniers)", "Sequoiadendron giganteum (S√©quoia g√©ant)",
            "Sorbus aucuparia 'Fastigiata' (Sorbier Fastigi√©)", "Taxus wallichiana (If de Wallich)", "Tilia monticola (Tilleul de montagne)", "Tsuga diversifolia (Pruche diverse)",
            "Ulmus rubra (Orme rouge)", "Wisteria sinensis 'Plena' (Glycine double)", "Abies magnifica (Sapin magnifique)", "Acacia paradoxa (Mimosa paradoxal)",
            "Acer griseum (√ârable gris)", "Celtis tournefortii (Micocoulier de Tournefort)", "Chamaecyparis obtusa 'Nana Gracilis' (Cypr√®s Hinoki nain)", "Crataegus crus-galli (Aub√©pine ergot de coq)",
            "Fagus mexicana (H√™tre du Mexique)", "Ilex vomitoria (Houx vomitoire)", "Juglans mandshurica (Noyer de Mandchourie)", "Juniperus sabina (Gen√©vrier sabine)",
            "Larix lyallii (M√©l√®ze subalpin)", "Liquidambar styraciflua 'Gumball' (Copalme Gumball)", "Magnolia acuminata (Magnolia acumin√©)", "Morus nigra (M√ªrier noir)",
            "Olea woodiana (Olivier de Wood)", "Picea mariana (√âpinette noire)", "Pinus radiata (Pin de Monterey)", "Platycladus orientalis (Thuya d'Orient)",
            "Populus grandidentata (Peuplier √† grandes dents)", "Prunus yedoensis (Cerisier Yoshino)", "Pyrus fauriei (Poirier de Faurie)", "Quercus garryana (Ch√™ne de Garry)",
            "Quercus virginiana (Ch√™ne de Virginie)", "Robinia pseudoacacia 'Frisia' (Robinier dor√©)", "Salix alba (Saule blanc)", "Sophora secundiflora (Sophora du Texas)",
            "Sorbus aria (Alisier blanc)", "Taxus brevifolia (If de l'Ouest)", "Tilia tomentosa (Tilleul argent√©)", "Tsuga caroliniana (Pruche de Caroline)",
            "Ulmus laevis (Orme lisse)", "Wisteria macrostachya (Glycine du Kentucky)", "Abies grandis (Sapin de Vancouver)", "Acacia senegal (Gomme arabique)",
            "Acer saccharinum (√ârable argent√©)", "Cercidiphyllum japonicum (Arbre √† caramel)", "Chamaecyparis thyoides 'Andelyensis' (Cypr√®s blanc Andelyensis)", "Crataegus pinnatifida (Aub√©pine de Chine)",
            "Fagus crenata (H√™tre japonais)", "Ilex opaca (Houx am√©ricain)", "Juglans rupestris (Noyer des roches)", "Juniperus scopulorum (Gen√©vrier des Rocheuses)",
            "Larix occidentalis (M√©l√®ze occidental)", "Liriodendron chinense (Tulipier de Chine)", "Magnolia obovata (Magnolia obovale)", "Morus kagayamae (M√ªrier de Kagayama)",
            "Olea ferruginea (Olivier ferrugineux)", "Picea rubens (√âpinette rouge)", "Pinus contorta (Pin tordu)", "Platanus occidentalis (Platane d'Am√©rique)",
            "Populus heterophylla (Peuplier des marais)", "Prunus lusitanica (Laurier du Portugal)", "Pyrus pyrifolia (Poirier nashi)", "Quercus imbricaria (Ch√™ne imbriqu√©)",
            "Quercus wislizeni (Ch√™ne de Wislizenus)", "Salix nigra (Saule noir)", "Sophora microphylla (Sophora √† petites feuilles)", "Sorbus commixta (Sorbier du Japon)"
        ];

        // Base simplifi√©e pour l'exemple
        const DB_SPECS = [
            {nom:"Acer", usda:"-15¬∞C", expo:"Mi-Ombre", type:"Caduc", potFreq: 2},
            {nom:"Pinus", usda:"-20¬∞C", expo:"Soleil", type:"Persistant", potFreq: 3},
            {nom:"Juniperus", usda:"-20¬∞C", expo:"Soleil", type:"Conif√®re", potFreq: 3},
            {nom:"Ficus", usda:"5¬∞C", expo:"Mi-Ombre", type:"Tropical", potFreq: 1},
            {nom:"Olea", usda:"-5¬∞C", expo:"Soleil", type:"Persistant", potFreq: 3},
            {nom:"Ulmus", usda:"-10¬∞C", expo:"Soleil", type:"Semi-P.", potFreq: 2},
            {nom:"Quercus", usda:"-20¬∞C", expo:"Soleil", type:"Caduc", potFreq: 3},
            {nom:"Picea", usda:"-25¬∞C", expo:"Soleil", type:"Conif√®re", potFreq: 4},
            {nom:"Prunus", usda:"-10¬∞C", expo:"Soleil", type:"Caduc", potFreq: 2},
            {nom:"Magnolia", usda:"-10¬∞C", expo:"Mi-Ombre", type:"Caduc", potFreq: 3},
            {nom:"Cedrus", usda:"-20¬∞C", expo:"Soleil", type:"Conif√®re", potFreq: 4},
            {nom:"Abies", usda:"-20¬∞C", expo:"Mi-Ombre", type:"Conif√®re", potFreq: 4},
            {nom:"Larix", usda:"-25¬∞C", expo:"Soleil", type:"Caduc", potFreq: 3},
            {nom:"Ginkgo", usda:"-20¬∞C", expo:"Soleil", type:"Caduc", potFreq: 2},
            {nom:"Taxus", usda:"-20¬∞C", expo:"Mi-Ombre", type:"Conif√®re", potFreq: 4},
            {nom:"Populus", usda:"-25¬∞C", expo:"Soleil", type:"Caduc", potFreq: 3},
            {nom:"Salix", usda:"-25¬∞C", expo:"Soleil", type:"Caduc", potFreq: 2},
            {nom:"Tilia", usda:"-20¬∞C", expo:"Mi-Ombre", type:"Caduc", potFreq: 3},
            {nom:"Ilex", usda:"-15¬∞C", expo:"Mi-Ombre", type:"Persistant", potFreq: 3},
            {nom:"Wisteria", usda:"-10¬∞C", expo:"Soleil", type:"Caduc", potFreq: 2},
            {nom:"Citrus", usda:"5¬∞C", expo:"Soleil", type:"Tropical", potFreq: 1},
            {nom:"Eucalyptus", usda:"-5¬∞C", expo:"Soleil", type:"Persistant", potFreq: 2}
            // Note: Pour les autres esp√®ces, la fonction getSpec utilisera "Esp√®ce Inconnue" par d√©faut.
        ];
        
        const UNKNOWN_SPEC = { nom: "Esp√®ce Inconnue", usda: "?", expo: "?", type: "?", potFreq: 0 };


        let bonsais = [];
        let currentUid = null;
        let currentPhotoBase64 = null;

        // --- 4. LOGIQUE PRINCIPALE ---
        window.onload = async function() {
            // Remplir datalist
            const dl = document.getElementById('species-list');
            SPECIES_RAW.forEach(s => { let o = document.createElement('option'); o.value=s; dl.appendChild(o); });
            
            // Initialisation des donn√©es asynchrones
            await refreshData();
            renderList();
        };

        async function refreshData() {
            try {
                bonsais = await dbApi.getAll();
            } catch (e) { console.error("Erreur de chargement DB:", e); bonsais = []; }
        }

        function getSpec(sid, name) {
            let found = DB_SPECS.find(s => name && name.includes(s.nom));
            return found ? { ...found, nom: name } : { nom: name || "Inconnu", ...UNKNOWN_SPEC };
        }

        // TRI ET FILTRE
        function getSortedBonsais() {
            const criteria = document.getElementById('sort-filter').value;
            let list = [...bonsais];
            
            if(criteria === 'name_asc') {
                list.sort((a,b) => (a.nom || getSpec(a.sid, a.customName).nom).localeCompare(b.nom || getSpec(b.sid, b.customName).nom));
            } else if (criteria === 'date_desc') {
                list.sort((a,b) => b.uid - a.uid);
            } else if (criteria === 'species_asc') {
                list.sort((a,b) => getSpec(a.sid, a.customName).nom.localeCompare(getSpec(b.sid, b.customName).nom));
            } else if (criteria === 'last_work') {
                const getLastWorkDate = (b) => {
                    // Ajout de lastDefo au calcul du dernier travail
                    const dates = [b.lastPot, b.lastCut, b.lastFertil, b.lastWire, b.lastDefo].filter(d => d).map(d => new Date(d));
                    return dates.length ? Math.max(...dates) : 0;
                };
                list.sort((a,b) => getLastWorkDate(b) - getLastWorkDate(a));
            }
            return list;
        }

        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            const sortedList = getSortedBonsais();
            document.getElementById('bonsai-count').innerText = sortedList.length;

            if(sortedList.length === 0) {
                container.innerHTML = `<div style="text-align:center;margin-top:40px;opacity:0.6"><i class="fa-solid fa-seedling" style="font-size:3rem;"></i><br><br>Aucun arbre.<br>Ajoutez-en un !</div>`;
                return;
            }

            sortedList.forEach(b => {
                let sp = getSpec(b.sid, b.customName);
                let name = b.nom || sp.nom.split('(')[0];
                
                let iconHtml = b.photo 
                    ? `<div class="thumb-icon" style="background-image: url('${b.photo}'); border-color:#ccc;"></div>`
                    : `<div class="thumb-icon style-√©rable-1"><i class="fa-solid fa-tree"></i></div>`;

                const div = document.createElement('div');
                div.className = 'bonsai-item';
                div.onclick = () => openEditor(b.uid);
                div.innerHTML = `
                    ${iconHtml}
                    <div style="flex:1">
                        <div style="font-weight:700;">${name}</div>
                        <div style="font-size:0.8rem; color:var(--secondary-text)">${sp.nom}</div>
                        <div style="font-size:0.7rem; margin-top:4px; color:#999"><i class="fa-solid fa-snowflake"></i> ${sp.usda} | <i class="fa-solid fa-sun"></i> ${sp.expo}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color:#ddd"></i>
                `;
                container.appendChild(div);
            });
        }

        // --- 5. LOGIQUE √âDITEUR (ASYNCHRONE) ---
        function openEditor(uid) {
            currentUid = uid;
            currentPhotoBase64 = null;
            
            // Reset Form
            document.querySelectorAll('input, select, textarea').forEach(i => i.value = "");
            document.getElementById('editor-title').innerText = uid ? "Modifier" : "Nouvel Arbre";
            document.getElementById('btn-delete').style.display = uid ? "block" : "none";
            
            if(uid) {
                const b = bonsais.find(x => x.uid === uid);
                if(b) {
                    document.getElementById('edit-species-input').value = b.customName;
                    document.getElementById('edit-name').value = b.nom || "";
                    document.getElementById('edit-date').value = b.date || "";
                    
                    document.getElementById('edit-last-pot').value = b.lastPot || "";
                    document.getElementById('edit-last-cut').value = b.lastCut || "";
                    document.getElementById('edit-last-fertil').value = b.lastFertil || "";
                    document.getElementById('edit-last-wire').value = b.lastWire || "";
                    document.getElementById('edit-last-defo').value = b.lastDefo || ""; // NOUVEAU: Effeuillage
                    document.getElementById('edit-notes').value = b.notes || ""; // NOUVEAU: Observations
                    
                    if(b.photo) currentPhotoBase64 = b.photo;
                }
            }
            updateSpecsFromInput();
            updateLeafPreview();
            nav('edit');
        }

        async function saveBonsai() {
            const speciesInput = document.getElementById('edit-species-input').value.trim();
            if(!speciesInput) return showToast("Veuillez choisir ou saisir une esp√®ce.", true);

            const item = {
                uid: currentUid || Date.now(),
                sid: 9999,
                customName: speciesInput,
                
                nom: document.getElementById('edit-name').value,
                date: document.getElementById('edit-date').value,
                photo: currentPhotoBase64,
                
                lastPot: document.getElementById('edit-last-pot').value,
                lastCut: document.getElementById('edit-last-cut').value,
                lastFertil: document.getElementById('edit-last-fertil').value,
                lastWire: document.getElementById('edit-last-wire').value,
                lastDefo: document.getElementById('edit-last-defo').value, // NOUVEAU: Effeuillage
                notes: document.getElementById('edit-notes').value // NOUVEAU: Observations
            };

            try {
                await dbApi.put(item);
                await refreshData();
                showToast(`Arbre "${item.nom || item.customName}" sauvegard√© !`);
                nav('list');
            } catch(e) {
                 showToast("Erreur de sauvegarde.", true);
            }
        }

        async function deleteBonsai() {
            const b = bonsais.find(x => x.uid === currentUid);
            const name = b.nom || b.customName;
            if(confirm(`Supprimer d√©finitivement l'arbre "${name}" ?`)) {
                await dbApi.delete(currentUid);
                await refreshData();
                showToast(`Arbre "${name}" supprim√©.`);
                nav('list');
            }
        }

        // --- UTILS & PHOTO LOGIC ---
        function updateSpecsFromInput() {
            const val = document.getElementById('edit-species-input').value;
            const sp = getSpec(0, val);
            document.getElementById('v-usda').innerText = sp.usda;
            document.getElementById('v-expo').innerText = sp.expo;
            document.getElementById('v-type').innerText = sp.type;
        }

        function handlePhotoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_W = 400; 
                        const scale = MAX_W / img.width;
                        canvas.width = MAX_W;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        updateLeafPreview();
                    };
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removePhoto() { currentPhotoBase64 = null; updateLeafPreview(); }

        function updateLeafPreview() {
            const img = document.getElementById('preview-image-tag');
            const ph = document.getElementById('placeholder-content');
            if(currentPhotoBase64) { img.src = currentPhotoBase64; img.style.display='block'; ph.style.display='none'; }
            else { img.style.display='none'; ph.style.display='flex'; }
        }

        function nav(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('screen-'+screen).classList.add('active');
            
            // Met en √©vidence le bouton correspondant dans la barre fixe en bas
            const navBtn = document.querySelector(`#nav-${screen}`);
            if(navBtn) navBtn.classList.add('active');

            if(screen === 'list') { 
                renderList(); 
            }
        }

        function showToast(msg, err=false) {
            const t = document.getElementById('toast');
            t.className = 'show'; t.style.background = err ? 'var(--danger)' : 'var(--success)';
            t.innerText = msg;
            setTimeout(() => t.className = t.className.replace('show',''), 3000);
        }

        // --- BACKUP & RESTORE (ASYNCHRONE) ---
        async function downloadBackup() {
            const data = await dbApi.getAll();
            if (data.length === 0) {
                showToast("Rien √† sauvegarder, la collection est vide.", true);
                return;
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "bonsai_backup_" + new Date().toISOString().slice(0,10).replace(/-/g, '') + ".json";
            a.click();
            showToast("Sauvegarde t√©l√©charg√©e !");
        }

        function restoreBackup() {
            const fileInput = document.getElementById('backup-file');
            const file = fileInput.files[0];
            if(!file) return showToast("Veuillez s√©lectionner un fichier JSON.", true);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        for(let item of data) await dbApi.put(item);
                        await refreshData();
                        fileInput.value = '';
                        showToast(`Restauration r√©ussie ! ${data.length} arbres charg√©s.`);
                        nav('list');
                    } else {
                        showToast("Le contenu du fichier est invalide.", true);
                    }
                } catch (err) {
                    showToast("Erreur de lecture : Fichier JSON invalide.", true);
                }
            };
            reader.readAsText(file);
        }
        
        async function resetApp() {
            if(confirm("ATTENTION : Cette action va EFFACER TOUS VOS BONS√ÑIS (photos incluses). Continuer ?")) { 
                await dbApi.clear();
                showToast("Application r√©initialis√©e.", true);
                setTimeout(() => location.reload(), 1500);
            }
        }
    </script>
</body>
</html>
